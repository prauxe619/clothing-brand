{% extends "base.html" %}

{% block title %}Saved Addresses{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
  <div class="bg-white rounded-lg shadow-xl overflow-hidden">
    <div class="p-8 border-b border-gray-200">
      <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Your Saved Addresses</h1>
    </div>

    <div class="p-8">
      {% if addresses %}
        <ul class="divide-y divide-gray-200">
          {% for addr in addresses %}
            <li class="py-6 flex flex-col sm:flex-row justify-between items-start sm:items-center">
              <div class="flex-grow">
                <p class="text-lg font-semibold text-gray-800">{{ addr.recipient_name }}</p>
                <div class="mt-2 text-sm text-gray-600">
                  <p>{{ addr.house_no }}, {{ addr.road }}, {{ addr.area }}</p>
                  <p>{{ addr.city }}, {{ addr.state }} - {{ addr.pincode }}</p>
                  <p class="mt-1">Mobile: {{ addr.mobile }}</p>
                  <span class="inline-flex items-center mt-2 px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                    {{ addr.label }}
                  </span>
                </div>
              </div>
              <div class="mt-4 sm:mt-0 flex space-x-3">
                <button
                  class="text-blue-600 hover:text-blue-800 font-medium text-sm transition-colors duration-200"
                  onclick="editAddress({{ addr.id }})"
                >
                  Edit
                </button>
                <button
                  class="text-red-600 hover:text-red-800 font-medium text-sm transition-colors duration-200"
                  onclick="deleteAddress({{ addr.id }})"
                >
                  Delete
                </button>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-center text-gray-500 py-10">You don't have any saved addresses yet.</p>
      {% endif %}
    </div>

    <div class="bg-gray-50 px-8 py-6 flex justify-end">
      <button
        onclick="showAddForm()"
        class="bg-black text-white font-semibold py-3 px-6 rounded-md hover:bg-gray-800 transition-colors duration-200 shadow-md flex items-center"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
        </svg>
        Add New Address
      </button>
    </div>
  </div>
</div>

<div id="addressFormContainer" class="fixed inset-0 z-50 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden p-4">
  <form id="addressForm" method="POST" action="{{ url_for('save_address') }}" 
        class="bg-white rounded-lg p-8 max-w-xl w-full shadow-2xl max-h-[90vh] overflow-y-auto transform transition-all duration-300 scale-95 opacity-0">
    <h2 id="formTitle" class="text-2xl font-bold text-gray-900 mb-6">Add New Address</h2>

    <input type="hidden" name="id" id="addressId" value="" />
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
      <div>
        <label for="recipient_name" class="block text-sm font-medium text-gray-700">Full Name</label>
        <input type="text" name="recipient_name" id="recipient_name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" />
      </div>
      <div>
        <label for="mobile" class="block text-sm font-medium text-gray-700">Mobile Number</label>
        <input type="tel" name="mobile" id="mobile" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" />
      </div>
      <div class="md:col-span-2">
        <label for="pincode" class="block text-sm font-medium text-gray-700">Pincode</label>
        <input type="text" name="pincode" id="pincode" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" />
      </div>
      <div class="md:col-span-2">
        <label for="house_no" class="block text-sm font-medium text-gray-700">House No., Building, Apartment</label>
        <input type="text" name="house_no" id="house_no" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" />
      </div>
      <div class="md:col-span-2">
        <label for="road" class="block text-sm font-medium text-gray-700">Road, Colony, Landmark</label>
        <input type="text" name="road" id="road" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" />
      </div>
      <div>
        <label for="city" class="block text-sm font-medium text-gray-700">City</label>
        <input type="text" name="city" id="city" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" />
      </div>
      <div>
        <label for="state" class="block text-sm font-medium text-gray-700">State</label>
        <input type="text" name="state" id="state" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" />
      </div>
      <div class="md:col-span-2">
        <label for="label" class="block text-sm font-medium text-gray-700">Address Label</label>
        <input type="text" name="label" id="label" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" />
      </div>
    </div>
    
    <div class="mt-6 flex items-center">
      <input type="checkbox" name="is_default" id="is_default" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" />
      <label for="is_default" class="ml-2 block text-sm text-gray-900">Set as Default Address</label>
    </div>

    <div class="mt-8 flex justify-end space-x-4">
      <button type="button" onclick="hideForm()" class="px-6 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">
        Cancel
      </button>
      <button type="submit" class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none">
        Save Address
      </button>
    </div>
  </form>
</div>

<script>
  const formContainer = document.getElementById('addressFormContainer');
  const formModal = document.getElementById('addressForm');
  const formTitle = document.getElementById('formTitle');
  const addressIdInput = document.getElementById('addressId');
  const isDefaultCheckbox = document.getElementById('is_default');

  const formFields = ['label', 'recipient_name', 'mobile', 'pincode', 'state', 'city', 'house_no', 'road', 'area'];

  function showAddForm() {
  formTitle.textContent = "Add New Address";
  addressIdInput.value = "";
  isDefaultCheckbox.checked = false;

  formFields.forEach(field => {
    const el = document.getElementById(field);
    if (el) el.value = "";   // ✅ just clear values
  });

    formContainer.classList.remove('hidden');
  setTimeout(() => {
    formModal.classList.remove('scale-95', 'opacity-0');
    formModal.classList.add('scale-100', 'opacity-100');
  }, 10);
}

  function editAddress(id) {
  const addresses = {{ addresses|tojson }};
  const addr = addresses.find(a => a.id === id);
  if (!addr) return alert("Address not found");

  formTitle.textContent = "Edit Address";
  addressIdInput.value = addr.id;
  formFields.forEach(field => {
    const el = document.getElementById(field);
    if (el) el.value = addr[field] || "";   // ✅ only edit uses addr
  });
  isDefaultCheckbox.checked = addr.is_default || false;

  formContainer.classList.remove('hidden');
  setTimeout(() => {
    formModal.classList.remove('scale-95', 'opacity-0');
    formModal.classList.add('scale-100', 'opacity-100');
  }, 10);
}


  function hideForm() {
    // Animate the modal out
    formModal.classList.remove('scale-100', 'opacity-100');
    formModal.classList.add('scale-95', 'opacity-0');
    setTimeout(() => {
        formContainer.classList.add('hidden');
    }, 300); // Match this duration with the CSS transition
  }
  
  // You'll need to create a Flask route and logic for this function
  function deleteAddress(id) {
    if (confirm("Are you sure you want to delete this address?")) {
      // You would typically make an AJAX request here to a Flask route to delete the address
      // For now, let's just log it.
      console.log(`Deleting address with ID: ${id}`);
      // After a successful deletion, you would reload the page or remove the element from the DOM.
      // window.location.reload(); 
    }
  }
</script>
{% endblock %}