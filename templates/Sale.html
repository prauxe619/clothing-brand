{% extends "base.html" %}

{% block content %}

    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Inter&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f5;
            margin: 0;
        }
        .collection-header {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            font-weight: 600;
            margin: 30px 20px 20px;
            text-align: center;
            color: #222;
            position: relative;
        }
        .collection-header::after {
            content: "";
            display: block;
            width: 50px;
            height: 3px;
            background-color: #000;
            margin: 6px auto 0;
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 2px;
            padding: 0 16px 40px;
            max-width: 1200px;
            margin: auto;
        }
        /* --- MEDIA QUERY FOR MOBILE LAYOUT (2 columns) --- */
        @media (max-width: 767px) {
            .product-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                padding: 0 10px 30px;
            }
            .product-image {
                height: clamp(140px, 45vw, 180px);
            }
            .product-name {
                font-size: 0.85rem;
            }
            .product-price {
                font-size: 0.95rem;
            }
            .wishlist-button {
                font-size: 18px; /* Adjusted for mobile */
                padding: 4px; /* Adjusted for mobile */
            }
        }
        @media (max-width: 480px) {
            .collection-header {
                font-size: 1.5rem;
            }
        }
        /* --- END MEDIA QUERY --- */
        .product-card {
            background: #fff;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
            text-align: center;
            padding: 12px;
            display: flex;
            flex-direction: column;
        }
        .product-card:hover {
            transform: translateY(-4px);
        }
        .product-card a.product-image-link {
            position: relative;
            display: block;
            width: 100%;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        .product-card a.product-image-link:hover .product-image {
            transform: scale(1.05);
        }
        .product-name {
            font-weight: 500;
            color: #333;
            margin: 6px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .product-price {
            font-weight: 600;
            color: #000;
            margin-bottom: 10px;
        }
        /* --- MODIFIED WISHLIST BUTTON STYLES --- */
        .wishlist-button {
            position: absolute;
            top: 8px; /* Adjust as needed */
            right: 8px; /* Adjust as needed */
            background: none; /* Removed background */
            border: none; /* Removed border */
            border-radius: 0; /* Removed border-radius */
            padding: 0; /* Removed padding */
            cursor: pointer;
            transition: transform 0.2s ease; /* Only transform for hover effect */
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: none; /* Removed box-shadow */
            z-index: 10;
        }
        .wishlist-button:hover {
            background-color: transparent; /* Ensure no background on hover */
            transform: scale(1.2); /* Slightly larger hover effect */
        }
        .wishlist-button i {
            font-size: 20px; /* Made icon smaller */
        }
        .wishlist-button .fas {
            color: #ef4444; /* Tailwind red-500 */
        }
        .wishlist-button .far {
            color: #9ca3af; /* Tailwind gray-400 */
        }
        /* --- END MODIFIED WISHLIST BUTTON STYLES --- */
    </style>

    <h2 class="collection-header">Sale</h2> {# Updated header #}
    <div style="max-width: 1200px; margin: 0 auto; padding: 0 16px 20px; display: flex; justify-content: flex-end;">
        <form method="GET" id="sort-form" style="display: flex; align-items: center; gap: 10px;">
            <label for="sort" style="font-weight: 500;">Sort by:</label>
            <select name="sort" id="sort" style="padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc;">
                <option value="default" {% if sort == 'default' %}selected{% endif %}>Default</option>
                <option value="popularity" {% if sort == 'popularity' %}selected{% endif %}>Popularity</option>
                <option value="price_desc" {% if sort == 'price_desc' %}selected{% endif %}>Price: High to Low</option>
                <option value="price_asc" {% if sort == 'price_asc' %}selected{% endif %}>Price: Low to High</option>
                <option value="newest" {% if sort == 'newest' %}selected{% endif %}>Newest</option>
            </select>
        </form>
    </div>

    <div class="product-grid">
        {% for product in products %}
            <div class="product-card">
                <a href="{{ url_for('product_details', product_id=product['id']) }}" class="product-image-link">
                    {# --- ROBUST IMAGE HANDLING --- #}
                    {% if product['image'] %}
                        <img class="product-image" src="{{ product['image'] }}" alt="{{ product['name'] }}" />
                    {% else %}
                        {# Fallback image if product.image is None or empty #}
                        <img class="product-image" src="{{ url_for('static', filename='default.png') }}" alt="Default Product Image" />
                    {% endif %}
                    {# --- END ROBUST IMAGE HANDLING --- #}

                    {# --- MOVED WISHLIST BUTTON --- #}
                    <button class="wishlist-button" data-id="{{ product['id'] }}">
                        {% if product['in_wishlist'] %}
                            <i class="fas fa-heart"></i> {# Solid heart for in wishlist #}
                        {% else %}
                            <i class="far fa-heart"></i> {# Outline heart for not in wishlist #}
                        {% endif %}
                    </button>
                    {# --- END MOVED WISHLIST BUTTON --- #}
                </a>
                <div class="product-name">{{ product['name'] }}</div>
                <div class="product-price">â‚¹{{ product['price'] }}</div>
            </div>
        {% endfor %}
    </div>

    <script>
        document.getElementById('sort').addEventListener('change', function () {
            document.getElementById('sort-form').submit();
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            console.log("DOMContentLoaded fired on women_collection.html");
            console.log("CSRF Token found:", csrfToken ? "Yes" : "No", csrfToken);
            document.body.addEventListener("click", function(e) {
                const button = e.target.closest(".wishlist-button");
                if (button) {
                    e.preventDefault();
                    e.stopPropagation();
                    const productId = button.dataset.id;
                    const icon = button.querySelector('i');
                    console.log("Wishlist button clicked for product ID:", productId);
                    console.log("Current icon classes:", icon ? icon.classList : "Icon element not found!");
                    if (!productId) {
                        console.error("Product ID is missing for wishlist button:", button);
                        alert("Error: Product ID missing for wishlist operation.");
                        return;
                    }
                    if (!csrfToken) {
                        console.error("CSRF Token is missing. Cannot perform AJAX request.");
                        alert("Error: Security token missing. Please refresh the page.");
                        return;
                    }
                    const size = 'N/A';
                    const color = 'N/A';
                    const payload = { product_id: productId, size: size, color: color };
                    console.log("Toggle Wishlist Request Payload:", payload);
                    console.log("Toggle Wishlist Request Headers:", {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrfToken,
                        "X-Requested-With": "XMLHttpRequest"
                    });
                    fetch('/add_to_wishlist', {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": csrfToken,
                            "X-Requested-With": "XMLHttpRequest"
                        },
                        body: JSON.stringify(payload)
                    })
                    .then(res => {
                        console.log("Wishlist Fetch Response Status:", res.status);
                        if (!res.ok) {
                            return res.json().then(errorData => {
                                throw new Error(errorData.message || `HTTP error! status: ${res.status}`);
                            }).catch(() => {
                                throw new Error(`HTTP error! status: ${res.status}`);
                            });
                        }
                        return res.json();
                    })
                    .then(data => {
                        console.log("Wishlist Fetch Response Data:", data);
                        if (data.success) {
                            if (icon) {
                                if (data.action === 'added') {
                                    icon.classList.remove('far', 'text-gray-400');
                                    icon.classList.add('fas', 'text-pink-600');
                                    alert(data.message || 'Product added to wishlist!');
                                } else {
                                    icon.classList.remove('fas', 'text-pink-600');
                                    icon.classList.add('far', 'text-gray-400');
                                    alert(data.message || 'Product removed from wishlist!');
                                }
                            } else {
                                console.warn("Icon element not found for wishlist button after fetch:", button);
                                alert(data.message || 'Wishlist updated, but icon could not be changed.');
                            }
                        } else {
                            alert('Error updating wishlist: ' + (data.message || 'Unknown error'));
                        }
                    })
                    .catch(err => {
                        console.error("Error toggling wishlist:", err);
                        alert("An error occurred while toggling wishlist. Please check console for details.");
                    });
                }
            });
        });
    </script>

{% endblock %}