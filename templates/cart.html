{% extends "base.html" %}
{% block title %}Your Cart | PRAUXE{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-6 py-10 pb-36 md:pb-10">
    <h2 class="text-3xl font-bold mb-8 text-center">Your Cart</h2>

    {% if cart_items %}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="md:col-span-2">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 md:grid-cols-1 md:gap-6">
                    {% for item in cart_items %}
                    {# normalize key parts: use 'None' when missing to match session key format #}
                    {% set size_key = item.size_name if item.size_name else 'None' %}
                    {% set color_key = item.color_name if item.color_name else 'None' %}
                    {% set item_key = item.product_id|string ~ '-' ~ size_key ~ '-' ~ color_key %}

                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 sm:gap-6 bg-white p-4 square-xl shadow hover:shadow-md transition"
     data-cart-item
     data-item-key="{{ item.product_id }}-{{ item.size_name or 'None' }}-{{ item.color_name or 'None' }}"
     data-product-id="{{ item.product_id }}"
     data-size="{{ item.size_name or 'N/A' }}"
     data-color="{{ item.color_name or 'N/A' }}">
    
    <!-- Product Image -->
    <a href="{{ url_for('product_details', product_id=item.product_id) }}" class="w-24 h-24 min-w-[6rem] min-h-[6rem] sm:w-32 sm:h-32 sm:min-w-[8rem] sm:min-h-[8rem] flex-shrink-0 squareed-lg bg-gray-100 overflow-hidden border border-gray-200 mx-auto sm:mx-0">
        {% if item.product and item.product.image %}
            <img src="{{ item.product.image }}" alt="{{ item.product.name }}" class="w-full h-full object-cover" />
        {% else %}
            <img src="{{ url_for('static', filename='default.png') }}" alt="Default Product" class="w-full h-full object-cover" />
        {% endif %}
    </a>

    <!-- Product Info -->
    <div class="flex-1 flex flex-col w-full text-center sm:text-left">
        <a href="{{ url_for('product_details', product_id=item.product_id) }}" class="text-lg font-semibold text-gray-800 hover:text-pink-600 transition-colors">
            {{ item.product.name }}
        </a>

        {% if item.size_name or item.color_name %}
            <p class="text-gray-780 text-sm mt-1">
                {% if item.size_name %}<span class="capitalize">Size: {{ item.size_name }}</span>{% endif %}
                {% if item.size_name and item.color_name %} | {% endif %}
                {% if item.color_name %}<span class="capitalize">Color: {{ item.color_name }}</span>{% endif %}
            </p>
        {% endif %}

        <p class="text-gray-500 text-sm mt-1">{{ format_price(item.product.price) }} each</p>

        <!-- Quantity Controls -->
        <div class="mt-3 flex items-center justify-center sm:justify-start space-x-2">
            <button type="button" class="decrease-quantity px-3 py-1 bg-gray-200 squareed hover:bg-gray-300 transition"
                    data-action="decrease"
                    data-product-id="{{ item.product_id }}"
                    data-size="{{ item.size_name or 'N/A' }}"
                    data-color="{{ item.color_name or 'N/A' }}">
                &#8722;
            </button>
            <span class="quantity-display font-semibold w-8 text-center">{{ item.quantity }}</span>
            <button type="button" class="increase-quantity px-3 py-1 bg-gray-200 squareed hover:bg-gray-300 transition"
                    data-action="increase"
                    data-product-id="{{ item.product_id }}"
                    data-size="{{ item.size_name or 'N/A' }}"
                    data-color="{{ item.color_name or 'N/A' }}">
                &#43;
            </button>
        </div>
    </div>

    <!-- Item Total & Actions -->
    <div class="flex flex-col items-center sm:items-start mt-4 w-full sm:w-auto sm:ml-auto">
        <p class="item-total text-xl font-bold text-gray-900 mb-4">{{ format_price(item.product.price * item.quantity) }}</p>
        <div class="flex flex-col sm:flex-row sm:space-x-2 space-y-2 sm:space-y-0 w-full">
            <button type="button" class="move-to-wishlist flex items-center justify-center px-4 py-2 border border-gray-300 text-gray-700 text-sm font-semibold squareed-md hover:bg-gray-100 transition whitespace-nowrap w-full sm:w-auto"
                    data-product-id="{{ item.product_id }}"
                    data-size="{{ item.size_name or 'N/A' }}"
                    data-color="{{ item.color_name or 'N/A' }}">
                Move to Wishlist
            </button>
            <button type="button" class="remove-from-cart-btn flex items-center justify-center px-4 py-2 bg-red-500 text-white text-sm font-semibold squareed-md hover:bg-red-600 transition whitespace-nowrap w-full sm:w-auto"
                    data-product-id="{{ item.product_id }}"
                    data-size="{{ item.size_name or 'N/A' }}"
                    data-color="{{ item.color_name or 'N/A' }}">
                Remove
            </button>
        </div>
    </div>
</div>

                    {% endfor %}
                </div>

                <div class="bg-white p-6 squareed-xl shadow mt-8">
                    {% include 'wishlist_section.html' %}
                </div>
            </div>

            <div class="hidden md:block md:col-span-1">
                <div class="bg-white p-6 square-xl shadow sticky top-24 h-fit">
                    <h3 class="text-xl font-bold mb-4">Order Summary</h3>
                    <div class="flex justify-between py-2 border-b">
                        <span>Total Items:</span>
                        <span id="total-items-desktop">{{ cart_items | length }}</span>
                    </div>
                    <div class="flex justify-between py-2 font-semibold text-lg">
                        <span>Total Amount:</span>
                        <span id="cart-total-desktop">{{ symbol }}{{ "%.2f"|format(total * rate) }}</span>
                    </div>
                    <a href="{{ url_for('create_order') }}" class="w-full bg-pink-600 text-white px-5 py-3 squareed-xl hover:bg-pink-700 transition-all duration-300 font-semibold shadow-md hover:shadow-lg block text-center mt-6">
                        Proceed to Checkout
                    </a>
                </div>
            </div>
        </div>

        <div class="fixed bottom-0 left-0 right-0 bg-white p-4 shadow-lg z-50 border-t border-gray-200 md:hidden">
            <div class="flex justify-between items-center w-full">
                <span class="text-xl font-bold">Total:</span>
                <span id="cart-total-mobile" class="text-xl font-bold mr-4">{{ symbol }}{{ "%.2f"|format(total * rate) }}</span>
                <a href="{{ url_for('create_order') }}" class="flex-1 bg-pink-600 text-white px-5 py-3 squareed-xl hover:bg-pink-700 transition-all duration-300 font-semibold shadow-md hover:shadow-lg text-center">
                    Proceed to Checkout
                </a>
            </div>
        </div>

    {% else %}
        <div class="text-center py-20 mb-8">
            <h3 class="text-2xl font-semibold mb-4">Your cart is empty ðŸ›’</h3>
            <p class="text-gray-500">Looks like you havenâ€™t added anything yet.</p>
            <a href="{{ url_for('home') }}" class="inline-block mt-6 bg-pink-600 text-white px-5 py-3 squareed-lg hover:bg-pink-700 transition">Start Shopping</a>
        </div>
        <div class="max-w-4xl mx-auto bg-white p-6 squareed-xl shadow mt-8">
            {% include 'wishlist_section.html' %}
        </div>
    {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    if (!csrfToken) console.warn("CSRF token missing from meta tag â€” AJAX POSTs may fail.");

    // Helper: normalize key used in data-item-key / session keys
    function normalizeKey(productId, size, color) {
        const sizePart = (size && size !== 'N/A') ? String(size) : 'None';
        const colorPart = (color && color !== 'N/A') ? String(color) : 'None';
        return `${productId}-${sizePart}-${colorPart}`;
    }

    // Helper: find cart DOM element by normalized key
    function findCartElementByKey(key) {
        const all = document.querySelectorAll('[data-cart-item]');
        for (let el of all) {
            if (el.dataset.itemKey === key) return el;
        }
        return null;
    }

    // Update cart UI after server actions
    function updateCartTotalsAndCounts(totalAmount) {
        if (typeof totalAmount !== 'undefined') {
            const desktop = document.getElementById('cart-total-desktop');
            const mobile = document.getElementById('cart-total-mobile');
            if (desktop) desktop.textContent = `â‚¹${Number(totalAmount).toFixed(2)}`;
            if (mobile) mobile.textContent = `â‚¹${Number(totalAmount).toFixed(2)}`;
        }

        const remainingItems = document.querySelectorAll('[data-cart-item]').length;
        const totalItemsDesktopDisplay = document.getElementById('total-items-desktop');
        if (totalItemsDesktopDisplay) totalItemsDesktopDisplay.textContent = remainingItems;
        return remainingItems;
    }

    // Event delegation for increase/decrease quantity
document.body.addEventListener('click', function(e) {
    const btn = e.target.closest('.increase-quantity, .decrease-quantity');
    if (!btn) return;

    const productId = btn.dataset.productId;
    const action = btn.dataset.action;
    const size = btn.dataset.size || 'N/A';
    const color = btn.dataset.color || 'N/A';

    if (!csrfToken) {
        alert("CSRF token missing. Please refresh the page.");
        return;
    }

    btn.disabled = true;

    fetch('/update_cart', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin',
        body: JSON.stringify({
            product_id: productId,
            action: action,
            size: size,
            color: color
        })
    })
    .then(async res => {
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.success) throw new Error(data.message || `HTTP ${res.status}`);
        return data;
    })
    .then(data => {
        const key = normalizeKey(productId, size, color);
        const row = findCartElementByKey(key);

        if (!row) {
            console.warn('Cart row not found, reloading...');
            return window.location.reload();
        }

        // Update quantity display
        const qtyEl = row.querySelector('.quantity-display');
        if (qtyEl && typeof data.quantity !== 'undefined') qtyEl.textContent = data.quantity;

        // Update item total
        const itemTotalEl = row.querySelector('.item-total');
        if (itemTotalEl && typeof data.item_total !== 'undefined') {
            itemTotalEl.textContent = `â‚¹${Number(data.item_total).toFixed(2)}`;
        }

        // Update total cart amount
        updateCartTotalsAndCounts(data.total_cart_amount);

        // Remove row if quantity is 0
        if (data.quantity === 0) {
            row.remove();
            if (updateCartTotalsAndCounts(data.total_cart_amount) === 0) window.location.reload();
        }
    })
    .catch(err => {
        console.error('Error updating cart:', err);
        alert(err.message || 'Failed to update cart.');
    })
    .finally(() => { btn.disabled = false; });
});


    // Move to wishlist (from cart)
    document.body.addEventListener('click', function(e) {
        const btn = e.target.closest('.move-to-wishlist');
        if (!btn) return;

        const productId = btn.dataset.productId;
        const size = btn.dataset.size || 'N/A';
        const color = btn.dataset.color || 'N/A';

        if (!confirm('Move this item to your wishlist?')) return;
        if (!csrfToken) { alert('CSRF token missing. Refresh the page.'); return; }

        btn.disabled = true;
        fetch('/move_cart_item_to_wishlist', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin',
            body: JSON.stringify({ product_id: productId, size: size, color: color })
        })
        .then(async res => {
            const data = await res.json().catch(()=>({}));
            if (!res.ok || !data.success) throw new Error(data.message || `HTTP ${res.status}`);
            return data;
        })
        .then(data => {
            const key = normalizeKey(productId, size, color);
            const row = findCartElementByKey(key);
            if (row) row.remove();
            updateCartTotalsAndCounts(data.total_cart_amount);
            alert(data.message || 'Moved to wishlist.');
            if (updateCartTotalsAndCounts(data.total_cart_amount) === 0) window.location.reload();
        })
        .catch(err => {
            console.error('Move to wishlist error:', err);
            alert(err.message || 'Failed to move to wishlist.');
        })
        .finally(() => { btn.disabled = false; });
    });

    // Remove from cart
    document.body.addEventListener('click', function(e) {
        const btn = e.target.closest('.remove-from-cart-btn');
        if (!btn) return;

        e.preventDefault();
        const productId = btn.dataset.productId;
        const size = btn.dataset.size || 'N/A';
        const color = btn.dataset.color || 'N/A';

        if (!productId) { alert('Product ID missing.'); return; }
        if (!csrfToken) { alert('CSRF token missing. Refresh the page.'); return; }

        if (!confirm('Remove this item from cart?')) return;

        btn.disabled = true;
        fetch('/remove_from_cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin',
            body: JSON.stringify({ product_id: productId, size: size, color: color })
        })
        .then(async res => {
            const data = await res.json().catch(()=> ({}));
            if (!res.ok || !data.success) throw new Error(data.message || `HTTP ${res.status}`);
            return data;
        })
        .then(data => {
            const key = normalizeKey(productId, size, color);
            const row = findCartElementByKey(key);
            if (row) row.remove();
            updateCartTotalsAndCounts(data.total_cart_amount);
            alert(data.message || 'Item removed.');
            if (updateCartTotalsAndCounts(data.total_cart_amount) === 0) window.location.reload();
        })
        .catch(err => {
            console.error('Remove from cart error:', err);
            alert(err.message || 'An error occurred while removing from cart.');
        })
        .finally(() => { btn.disabled = false; });
    });
});
</script>
{% endblock %}
